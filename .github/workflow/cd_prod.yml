name: Deploy to Production
on:
  push:
    braches: ["main"]

jobs:
  redeploy_everthing:
  runs-on: unbuntu-latest
  name: deploy everthing to the production

  steps:
    -run: |
      echo ${{secrets.SSH_PRIVATE_KEY}} &> ~/ssh_key
      mkdir -p /home/runner/.ssh
      chmod 700 /home/runner/ssh_key
      ssh -i ~/ssh_key -o StrictHostKeyChecking=no ubuntu@13.203.226.64 -t
      "cd CanvasFlow && git pull origin production &&
      export PATH=/home/ubuntu/.nvm/versions/node/v22.17.1/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin &&
      npm install -g pnpm && 
      pnpm install &&
      pnpm build &&
      pm2 restart frontend &&
      pm2 restart backend &&
      pm2 restart webSockt"
